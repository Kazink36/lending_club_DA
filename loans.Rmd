---
title: "Lending Club Loan Data Analysis"
author: "Jared Lee"
date: "5/31/2020"
output: github_document
#always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

## Summary 

In a football game, the coach must decide on what play to run on offense. The options for these play calls can be broken down into either a pass, a run, or a kick -- which can be either a field goal attempt or a punt. Many factors influence the decision: field position, down and distance, time left on the clock, and the score. The purpose of this analysis is to develop a model that will predict what type of play a coach will call in a given situation. To accomplish this, I looked at information on the University of Utah's football team from the 2019 season with head coach Kyle Whittingham.

## Preparations 

This first chunk loads the necessary R packages.

```{r loading_packages, message = FALSE,warning=FALSE}
library(plotly)
library(tidymodels)
library(tidyverse)
```

## Analysis

### Data

  Retrieved May 31, 2020 from [Kaggle](https://www.kaggle.com/wendykan/lending-club-loan-data). These files contain complete loan data for all loans issued through the 2007-2015, including the current loan status (Current, Late, Fully Paid, etc.) and latest payment information. The file containing loan data through the "present" contains complete loan data for all loans issued through the previous completed calendar quarter.


```{r, message = FALSE,warning=FALSE,results='hide'}
# Read the file
loans <- read_csv("loan.csv")

# View Structure of Data
str(loans)
head(loans)
```

```{r}
# Summary of some key character columns
summary(as.factor(loans$term))
summary(as.factor(loans$grade))
summary(as.factor(loans$sub_grade))
summary(as.factor(loans$emp_length))
summary(as.factor(loans$home_ownership))
summary(as.factor(loans$purpose))
# Loan status is the most important column
summary(as.factor(loans$loan_status))
```

### Preprocessing

  ASDF

```{r}
# To simplify, loan status will be grouped into 3 categories: Current, Good, Bad
good_loans <- c("Does not meet the credit policy. Status:Fully Paid","Fully Paid")
bad_loans <- c("Charged Off","Does not meet the credit policy. Status:Charged Off","Default","Late (31-120 days)")
current_loans <- c("Current","In Grace Period","Late (16-30 days)")

loans <- loans %>%
  mutate(outcome = case_when(loan_status %in% good_loans ~ "Good Loan",
                             loan_status %in% bad_loans ~ "Bad Loan",
                             loan_status %in% current_loans ~ "Current",
                             TRUE ~ "Other"))
# Make Sure that all loan_status are converted (no "Other"s)
summary(as.factor(loans$outcome))
# Filter out current loans
finished_loans <- loans %>%
  filter(outcome != "Current")
```

### Exploratory Analysis

  ASDF

```{r, message=FALSE, warning=FALSE}
plotData <- function(data,group,label = group) {
  colors <- c("#D33016","#1BA9C2") #Bad,Good
  if(is.numeric(data[[group]])) {
    data %>%
      ggplot(aes(x = .data[[group[[1]]]],fill = outcome)) +
      geom_density(alpha = 0.5) +
      scale_fill_manual(values = colors) +
      labs(x = label,y = NULL,fill = NULL) +
      theme_minimal()
  } else {
    data %>%
      group_by(.data[[group[[1]]]],outcome) %>%
      summarize(Count = n()) %>%
      mutate(Proportion = Count/sum(Count)) %>%
      pivot_longer(Count:Proportion) %>%
      ggplot(aes(x = .data[[group[[1]]]],y = value,fill = outcome))+
      geom_col()+
      labs(x = label,y = NULL,fill = NULL) +
      scale_fill_manual(values = colors) + 
      facet_wrap(~name,scales = "free_x") +
      coord_flip() +
      theme_minimal()
  }
}
```

```{r}
plotData(finished_loans,"int_rate",label = "Interest Rate")
```

  ASDF
  
#### Key Takeaways

* Point 1

* Point 2

```{r}
plotData(finished_loans,"loan_amnt",label = "Loan Amount")
```

ASDF

#### Key Takeaways

* Point 1

* Point 2

```{r, message=FALSE, warning=FALSE}
plotData(finished_loans,"term",label = "Loan Length")
```

```{r, message=FALSE, warning=FALSE,echo=FALSE}
plotData(finished_loans,"sub_grade",label = "Grade")
```

ASDF

#### Key Takeaways

* POint 1

```{r, message=FALSE, warning=FALSE}
finished_loans %>%
  mutate(emp_length = fct_relevel(emp_length,"10+ years",after = 10)) %>%
  mutate(emp_length = fct_relevel(emp_length,"n/a")) %>%
  plotData("emp_length",label = "Years Employed")
```

```{r, message=FALSE, warning=FALSE, echo=FALSE}
plotData(finished_loans,"home_ownership",label = "Home Ownership")
```

ASDF

```{r}
# library(plotly)
# g <- list(
#   scope = 'usa',
#   projection = list(type = 'albers usa'),
#   showlakes = TRUE,
#   lakecolor = toRGB('white')
# )
# finished_loans %>%
#   count(addr_state,outcome) %>%
#   group_by(addr_state) %>%
#   mutate(prop = round(n/sum(n)*100,2),
#          n_tot = sum(n)) %>%
#   filter(outcome == "Bad Loan") %>%
#   plot_geo(locationmode = 'USA-states') %>%
#   add_trace(locations= ~addr_state,color = ~prop, z= ~prop,hoverinfo = "text",
#             text= ~paste0("Number of Loans: ",n_tot,"\nGood Loans: ",100-prop,"%\nBad Loans: ",prop,"%"),
#             colorscale = "RdBu") %>%
#   colorbar(title = "") %>% 
#   layout(
#     title = 'Percentage of Loans that are "Bad"',
#     geo = g
#   )
```

```{r}
map <- map_data("state")
state_link <-tibble(abbr = state.abb,name = tolower(state.name))
state_centers <- bind_cols(as.tibble(state.center),state_link)
state_counts<- finished_loans %>%
  count(addr_state, outcome) %>%
  group_by(addr_state) %>%
  mutate(prop = round(n/sum(n)*100,1),
         n_tot = sum(n)) %>%
  filter(outcome == "Good Loan") 
midpoint = (max(state_counts$prop) + min(state_counts$prop)) / 2
labelDF <- state_counts %>%
  left_join(state_centers,by = c("addr_state" = "abbr"))
state_counts %>%
  left_join(state_link,by = c("addr_state"="abbr")) %>%
  right_join(map,by = c("name" = "region")) %>%
  ggplot(aes(x = long,y = lat,group = group,fill = prop)) +
  geom_polygon(color = "white") +
  geom_text(data = labelDF,aes(x = x,y = y,group = NULL,label = paste0(prop,"%"))) +
  scale_fill_gradient2(low = "red",mid = "gray50",high = "blue",midpoint = midpoint,
                       labels = function(x){paste0(x,"%")},
                       n.breaks = 4,name = 'Percentage of \n"Good Loans"') +
  theme_void()
```



#### Key Takeaways

* Point 1



## Modeling

### Model Preperation

ASDF

```{r}



```



## Model Comparison

ASDf

### Model Metrics

ASDF

```{r}


```

ASDF

```{r}

```



## Conclusion



### Future Work




